name: Branch Cleanup

on:
  pull_request:
    types: [closed]
  schedule:
    - cron: "0 2 * * 0" # ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤ì „ 2ì‹œ

jobs:
  cleanup-merged-branches:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Delete merged branch
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          if [[ "$BRANCH_NAME" != "main" && "$BRANCH_NAME" != "develop" ]]; then
            echo "ğŸ—‘ï¸ Deleting merged branch: $BRANCH_NAME"
            git push origin --delete "$BRANCH_NAME" || echo "Branch already deleted"
          fi

  cleanup-stale-branches:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find stale branches
        run: |
          echo "ğŸ” Finding branches older than 30 days..."
          git for-each-ref --format='%(refname:short) %(committerdate)' refs/remotes/origin | \
          while read branch date; do
            if [[ "$branch" != "origin/main" && "$branch" != "origin/develop" ]]; then
              if [[ $(date -d "$date" +%s) -lt $(date -d "30 days ago" +%s) ]]; then
                BRANCH_NAME=${branch#origin/}
                echo "âš ï¸  Stale branch found: $BRANCH_NAME (last commit: $date)"
                # ì‹¤ì œ ì‚­ì œëŠ” ìˆ˜ë™ìœ¼ë¡œ í•˜ë„ë¡ ì´ìŠˆ ìƒì„±
              fi
            fi
          done
